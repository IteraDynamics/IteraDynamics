name: Sleeve 2 Backtest & Selection

on:
  workflow_dispatch:
  push:
    branches:
      - feature/sleeve2-candidates

jobs:
  backtest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn requests
      
      - name: Verify data files exist
        run: |
          ls -lh data/btcusd_3600s_2023-01-01_to_2025-12-30.csv
          ls -lh data/btcusd_3600s_2019-01-01_to_2025-12-30.csv
      
      - name: Create output directories
        run: |
          mkdir -p results
          mkdir -p logs
      
      - name: Run simple backtests
        run: |
          python3 << 'PYEOF'
          import sys
          import os
          import pandas as pd
          import numpy as np
          import json
          from datetime import datetime
          
          sys.path.insert(0, './runtime/argus')
          
          # Import strategies
          from research.strategies.sg_core_exposure_v2 import generate_intent as core
          from research.strategies.sg_mean_reversion_a import generate_intent as sleeve2a
          from research.strategies.sg_mean_reversion_b import generate_intent as sleeve2b
          from research.strategies.sg_mean_reversion_c import generate_intent as sleeve2c
          
          # Set environment for Core strategy
          os.environ['SG_CORE_ENABLE_MACRO_FILTER'] = '1'
          os.environ['SG_CORE_MACRO_EMA_LEN'] = '2000'
          os.environ['SG_CORE_MACRO_EXPO_CAP_BEAR'] = '0.00'
          
          def simple_backtest(strategy_func, df, name):
              """Run a simple backtest"""
              equity = 1.0
              position = 0.0
              entry_price = 0.0
              trades = 0
              wins = 0
              equities = []
              
              for i in range(100, len(df)):
                  window = df.iloc[:i]
                  px = float(df.iloc[i]['Close'])
                  
                  try:
                      intent = strategy_func(window, {}, closed_only=True)
                      action = intent['action']
                      
                      if action == "ENTER_LONG" and position == 0:
                          position = intent.get('desired_exposure_frac', 0.5)
                          entry_price = px
                          trades += 1
                      elif action == "EXIT_LONG" and position > 0:
                          pnl = (px / entry_price - 1) * position
                          equity *= (1 + pnl)
                          if pnl > 0:
                              wins += 1
                          position = 0
                      
                      mtm = equity * (1 + (px / entry_price - 1) * position) if position > 0 else equity
                      equities.append(mtm)
                  except:
                      equities.append(equity)
              
              equities = pd.Series(equities)
              running_max = equities.expanding().max()
              dd = ((equities - running_max) / running_max * 100).min()
              total_return = (equity - 1) * 100
              years = (df.index[-1] - df.index[100]).days / 365.25
              cagr = (equity ** (1/years) - 1) * 100
              calmar = cagr / abs(dd) if dd != 0 else 0
              win_rate = wins / trades * 100 if trades > 0 else 0
              
              return {
                  'name': name,
                  'total_return': total_return,
                  'cagr': cagr,
                  'max_drawdown': dd,
                  'calmar': calmar,
                  'trades': trades,
                  'win_rate': win_rate
              }
          
          # Load data
          print("Loading data...")
          df = pd.read_csv('data/btcusd_3600s_2023-01-01_to_2025-12-30.csv')
          df['Timestamp'] = pd.to_datetime(df['Timestamp'])
          df = df.set_index('Timestamp')
          
          # Run backtests
          strategies = [
              (core, 'Core v2'),
              (sleeve2a, 'Sleeve 2A (RSI)'),
              (sleeve2b, 'Sleeve 2B (Bollinger)'),
              (sleeve2c, 'Sleeve 2C (Hybrid)')
          ]
          
          results = []
          for strat_func, name in strategies:
              print(f"\nBacktesting {name}...")
              result = simple_backtest(strat_func, df, name)
              results.append(result)
              print(f"  CAGR: {result['cagr']:.2f}%")
              print(f"  MaxDD: {result['max_drawdown']:.2f}%")
              print(f"  Calmar: {result['calmar']:.2f}")
          
          # Save results
          with open('results/summary.json', 'w') as f:
              json.dump(results, f, indent=2)
          
          # Print summary
          print("\n" + "="*80)
          print("BACKTEST RESULTS (2023-2025)")
          print("="*80)
          print(f"{'Strategy':<25} {'CAGR':<10} {'MaxDD':<10} {'Calmar':<10} {'Trades':<10}")
          print("-"*80)
          for r in results:
              print(f"{r['name']:<25} {r['cagr']:>8.2f}% {r['max_drawdown']:>8.2f}% "
                    f"{r['calmar']:>9.2f} {r['trades']:>9}")
          
          # Find winner among Sleeve 2 candidates (skip Core)
          candidates = [r for r in results if 'Sleeve' in r['name']]
          if candidates:
              winner = max(candidates, key=lambda x: x['calmar'])
              print("\n" + "="*80)
              print("RECOMMENDATION")
              print("="*80)
              print(f"\nüèÜ WINNER: {winner['name']}")
              print(f"   CAGR: {winner['cagr']:.2f}%")
              print(f"   Calmar: {winner['calmar']:.2f}")
              print(f"   Max DD: {winner['max_drawdown']:.2f}%")
          
          PYEOF
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: sleeve2-backtest-results
          path: |
            results/*.json
      
      - name: Display Summary
        run: |
          echo "üìä Backtest Complete"
          echo ""
          cat results/summary.json
